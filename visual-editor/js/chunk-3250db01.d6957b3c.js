(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-3250db01"],{"6d73":function(t,e,a){"use strict";var i=a("18a6");e["a"]={Scene:{list:function(t){return Object(i["a"])({url:"/scenario/strategy/list",method:"post",data:t})},add:function(t){return Object(i["a"])({url:"/scenario/strategy/add",method:"post",data:t})},edit:function(t){return Object(i["a"])({url:"/scenario/strategy/edit",method:"post",data:t})},delete:function(t){return Object(i["a"])({url:"/scenario/strategy/delete",method:"post",data:t})},get:function(t){return Object(i["a"])({url:"/scenario/strategy/detail",method:"post",data:t})},logList:function(t){return Object(i["a"])({url:"/v1/scenario/log/list",method:"post",data:t})},logDetail:function(t){return Object(i["a"])({url:"/v1/scenario/log/detail/list",method:"post",data:t})},active:function(t){return Object(i["a"])({url:"/scenario/strategy/activate",method:"post",data:t})}},Control:{add:function(t){return Object(i["a"])({url:"/v1/automation/add",method:"post",data:t})},edit:function(t){return Object(i["a"])({url:"/v1/automation/edit",method:"post",data:t})},delete:function(t){return Object(i["a"])({url:"/v1/automation/delete",method:"post",data:t})},enabled:function(t){return Object(i["a"])({url:"/v1/automation/enabled",method:"post",data:t})},list:function(t){return Object(i["a"])({url:"/v1/automation/list",method:"post",data:t})},get:function(t){return Object(i["a"])({url:"/v1/automation/detail",method:"post",data:t})},logList:function(t){return Object(i["a"])({url:"/v1/automation/log/list",method:"post",data:t})},logDetail:function(t){return Object(i["a"])({url:"/v1/automation/log/detail/list",method:"post",data:t})}}}},9924:function(t,e,a){"use strict";a.r(e);var i=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("el-dialog",{staticClass:"el-dark-dialog",attrs:{title:t.formData.id?"编辑":"新增","close-on-click-modal":!1,visible:t.dialogVisible,width:"60%",height:"60%",top:"10vh"},on:{"update:visible":function(e){t.dialogVisible=e}}},[a("el-form",{attrs:{"label-position":"left","label-width":"85px"}},[a("el-form-item",{attrs:{label:t.$t("AUTOMATION.SCENE_TITLE"),required:""}},[a("el-input",{ref:"nameRef",model:{value:t.formData.scenario_name,callback:function(e){t.$set(t.formData,"scenario_name",e)},expression:"formData.scenario_name"}})],1),a("el-form-item",{attrs:{label:t.$t("AUTOMATION.SCENE_DESCRIPTION")}},[a("el-input",{model:{value:t.formData.scenario_description,callback:function(e){t.$set(t.formData,"scenario_description",e)},expression:"formData.scenario_description"}})],1),a("el-form-item",{attrs:{label:t.$t(""),required:""}},t._l(t.formData.commands,(function(e,i){return a("div",{key:i,staticStyle:{display:"flex","margin-bottom":"10px"}},[a("DeviceTypeSelector",{ref:"deviceTypeRef",refInFor:!0,attrs:{data:e.data,option:{operator:!1,mode:"action"}},on:{change:function(a){return t.handleCommandChange(e,a)}}}),0==i?a("el-button",{staticStyle:{"margin-left":"auto"},attrs:{type:"indigo",size:"small"},on:{click:function(a){return t.handleAddCommand(e)}}},[t._v(t._s(t.$t("AUTOMATION.ADD_LINE")))]):t._e(),i>0?a("el-button",{staticStyle:{"margin-left":"auto"},attrs:{type:"danger",size:"small"},on:{click:function(a){return t.handleDeleteCommand(e)}}},[t._v(t._s(t.$t("AUTOMATION.DELETE")))]):t._e()],1)})),0),a("div",{staticClass:"text-right"},[a("el-button",{attrs:{size:"medium",type:"cancel"},on:{click:t.handleSubmit}},[t._v(t._s(t.$t("AUTOMATION.SAVE")))])],1)],1)],1)},n=[],o=(a("e9c4"),a("d81d"),a("b0c0"),a("c740"),a("a434"),a("b64b"),a("5c97")),r=a("6d73"),s=a("2fa3"),d={name:"EditForm",components:{DeviceTypeSelector:o["default"]},props:{id:{type:[String],default:""},visible:{type:[Boolean],default:!1}},data:function(){return{formData:{scenario_name:"",scenario_description:""}}},computed:{dialogVisible:{get:function(){return this.visible},set:function(t){this.$emit("update:visible",t)}}},watch:{visible:{handler:function(t){t?this.id?this.getScene(this.id):this.formData={scenario_name:"",scenario_description:"",commands:[{data:{}}]}:this.formData={}}}},methods:{handleAddCommand:function(){this.formData.commands.push({data:{}})},handleSubmit:function(){var t=this;if(this.validate()){var e=JSON.parse(JSON.stringify(this.formData));e.scenario_actions=this.formData.commands.map((function(t){console.log("handleSubmit",t);var e=t.data.state,a=e.name,i=e.type,n=e.mode,o=e.operator,r={},d="1";return"custom"===n?(d="3",r=t.data.state.params):(d="1",r[a]=Object(s["j"])(o.value,i)),{action_type:"1",device_id:t.data.deviceId,device_model:d,instruct:JSON.stringify(r),remark:"备注"}})),this.formData.id?r["a"].Scene.edit(e).then((function(e){var a=e.data;200===a.code&&(t.dialogVisible=!1,t.$emit("submit"),Object(s["i"])("编辑成功!"))})):r["a"].Scene.add(e).then((function(e){var a=e.data;200===a.code&&(t.dialogVisible=!1,t.$emit("submit"),Object(s["i"])("新增成功!"))})),console.log("====scene.EditForm",this.formData)}},handleCommandChange:function(t,e){t.data=e},handleDeleteCommand:function(t){var e=this.formData.commands.findIndex((function(e){return e==t}));this.formData.commands.splice(e,1)},getScene:function(t){var e=this;r["a"].Scene.get({id:t}).then((function(t){var a=t.data;if(200===a.code){var i=(null===a||void 0===a?void 0:a.data)||"{}";if("{}"!==i){var n=e.getCommands(JSON.parse(JSON.stringify(i)));console.log("getScene.commands",n);var o=JSON.parse(JSON.stringify(i));o.commands=n,e.formData=o}}}))},getCommands:function(t){var e=(null===t||void 0===t?void 0:t.scenario_actions)||[],a=e.map((function(t){var e=JSON.parse(t.instruct),a=Object.keys(e)[0],i=e[a],n={};return"1"===t.device_model?(n={name:a,mode:"property",operator:{symbol:"",value:i}},JSON.stringify(n)):"2"===t.device_model?(n={name:t.instruct.method,mode:"command",params:JSON.stringify(t.instruct.params)},JSON.parse(n)):"3"===t.device_model&&(n={name:"custom",mode:"custom",params:JSON.parse(t.instruct)},JSON.stringify(n)),{data:{projectId:t.business_id,groupId:t.asset_id,deviceId:t.device_id,state:n,stateJSON:JSON.stringify(n)}}}));return a},validate:function(){if(!this.formData.scenario_name||""===this.formData.scenario_name)return this.$refs.nameRef.focus(),Object(s["h"])(this.$t("AUTOMATION.SCENE_NAME")),!1;for(var t=0;t<this.$refs.deviceTypeRef.length;t++){var e=this.$refs.deviceTypeRef[t];if(!e.validate())return!1}return!0}}},c=d,l=a("2877"),m=Object(l["a"])(c,i,n,!1,null,"4436e865",null);e["default"]=m.exports}}]);