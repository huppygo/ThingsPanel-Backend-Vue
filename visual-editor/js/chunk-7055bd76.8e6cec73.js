(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-7055bd76","chunk-b48ec758"],{"199b":function(t,e,n){"use strict";n.r(e);var a=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("el-dialog",{staticClass:"el-dark-dialog",attrs:{title:t.formData.id?"编辑":"新增","close-on-click-modal":!1,visible:t.dialogVisible,height:"60%",top:"10vh","custom-class":"edit-dialog"},on:{"update:visible":function(e){t.dialogVisible=e}}},[n("el-form",{attrs:{"label-position":"left","label-width":"85px"}},[n("el-form-item",{attrs:{label:t.$t("AUTOMATION.SCENE_TITLE"),required:""}},[n("el-input",{ref:"nameRef",model:{value:t.formData.scenario_name,callback:function(e){t.$set(t.formData,"scenario_name",e)},expression:"formData.scenario_name"}})],1),n("el-form-item",{attrs:{label:t.$t("AUTOMATION.SCENE_DESCRIPTION")}},[n("el-input",{model:{value:t.formData.scenario_description,callback:function(e){t.$set(t.formData,"scenario_description",e)},expression:"formData.scenario_description"}})],1),n("el-form-item",{attrs:{label:t.$t(""),required:""}},[t._l(t.actions,(function(e,a){return n("div",{key:a,staticStyle:{display:"flex","margin-bottom":"10px"}},[n("el-select",{ref:"actionTypeRef",refInFor:!0,staticStyle:{width:"130px","margin-right":"20px"},attrs:{"no-data-text":t.$t("COMMON.SELECT_NO_DATA"),placeholder:t.$t("AUTOMATION.PLACEHOLDER.ACTION_TYPE"),disabled:t.actions.length>a+1},model:{value:e.type,callback:function(n){t.$set(e,"type",n)},expression:"action.type"}},t._l(e.typeOptions,(function(t,e){return n("el-option",{key:e,attrs:{label:t.label,value:t.value}})})),1),"device"===e.type?n("CommandDevice",{ref:"commandRef",refInFor:!0,staticStyle:{width:"100%"},attrs:{data:e.commands},on:{change:function(n){return t.handleCommandChange(e,n)}}}):t._e(),"scene"===e.type?n("SceneSelector",{ref:"sceneRef",refInFor:!0,staticStyle:{width:"100%"},attrs:{data:e.scenes},on:{change:function(n){return t.handleSceneChange(e,n)}}}):t._e(),"alarm"===e.type?n("AlarmNotification",{ref:"alarmRef",refInFor:!0,staticStyle:{width:"100%"},attrs:{data:e.alarm},on:{change:function(n){return t.handleAlarmChange(e,n)}}}):t._e(),n("div",{staticStyle:{"margin-left":"20px"}},[n("el-button",{staticStyle:{height:"40px"},attrs:{type:"danger",size:"small","v-if":t.actions.length>0},on:{click:function(n){return t.handleDeleteAction(e)}}},[t._v(t._s(t.$t("AUTOMATION.DELETE")))])],1)],1)})),n("el-button",{attrs:{type:"border",size:"mini",disabled:t.actions.length>2},on:{click:t.handleAddAction}},[t._v(t._s(t.$t("AUTOMATION.ADD_ACTION_TYPE")))])],2),n("div",{staticClass:"text-right"},[n("el-button",{attrs:{size:"medium",type:"cancel"},on:{click:t.handleSubmit}},[t._v(t._s(t.$t("AUTOMATION.SAVE")))])],1)],1)],1)},i=[],o=n("5530"),s=(n("e9c4"),n("d3b7"),n("159b"),n("c740"),n("a434"),n("d81d"),n("4de4"),n("7db0"),n("b0c0"),n("b64b"),n("4127e")),c=n("37d3"),r=n("15b8"),l=n("6d73"),d=n("2fa3"),u=n("f570"),m=[{label:u["a"].t("AUTOMATION.OPERATING_DEVICE"),value:"device"},{label:"触发联动规则",value:"scene"},{label:u["a"].t("AUTOMATION.TRIGGER_ALARM"),value:"alarm"}],f={name:"EditForm",components:{CommandDevice:s["default"],SceneSelector:c["default"],AlarmNotification:r["default"]},props:{id:{type:[String],default:""},visible:{type:[Boolean],default:!1}},data:function(){return{formData:{scenario_name:"",scenario_description:""},actions:[{type:"",typeOptions:m,disabled:!1}]}},computed:{dialogVisible:{get:function(){return this.visible},set:function(t){this.$emit("update:visible",t)}}},watch:{visible:{handler:function(t){t?this.id?this.getSceneDetail(this.id):(this.formData={scenario_name:"",scenario_description:""},this.actions=[],this.setActionTypeOptions()):this.formData={}}}},methods:{setActionTypeOptions:function(){var t=JSON.parse(JSON.stringify(m));this.actions.forEach((function(e){if(e.type){e.typeOptions=JSON.parse(JSON.stringify(t));var n=t.findIndex((function(t){return t.value==e.type}));t.splice(n,1)}}))},handleAddAction:function(){var t=this.actions.every((function(t){return""!=t.type}));if(t){var e=this.actions.map((function(t){return t.type})),n=m.filter((function(t){return!e.some((function(e){return e==t.value}))}));this.actions.push({type:"",typeOptions:n,disabled:!1})}else Object(d["h"])(this.$t("AUTOMATION.ERROR.ACTION_TYPE"))},handleDeleteAction:function(t){this.actions=this.actions.filter((function(e){return e!=t})),this.setActionTypeOptions()},handleAddCommand:function(){this.formData.commands.push({data:{}})},handleSubmit:function(){var t,e=this;if(console.log("handleSubmit.formData",this.formData),console.log("handleSubmit.actions",this.actions),this.validate()){var n=JSON.parse(JSON.stringify(this.formData));if(n.scenario_actions=[],this.actions.commands=this.actions.commands?this.actions.commands:(null===(t=this.actions.find((function(t){return"device"===t.type})))||void 0===t?void 0:t.commands)||null,console.log("this.actions.commands",this.actions),this.actions.commands&&this.actions.commands.forEach((function(t){console.log("cmd",t);var e=t.state,a=e.name,i=e.type,o=e.mode,s=e.operator,c={},r="1";"command"===o?(r="2",c.method=t.state.name,c.params=t.state.params):(r="1",c[a]=Object(d["j"])(s.value,i)),n.scenario_actions.push({action_type:"1",device_id:t.deviceId,device_model:r,instruct:JSON.stringify(c),remark:""})})),this.actions.scenes=this.actions.scenes?this.actions.scenes:this.actions.find((function(t){return"scene"===t.type})),this.actions.scenes&&this.actions.scenes.forEach((function(t){var e={automation_id:t.id,switch:t.switch};n.scenario_actions.push({action_type:"2",device_id:"",device_model:"",instruct:JSON.stringify(e),remark:""})})),this.actions.alarm=this.actions.alarm?this.actions.alarm:this.actions.find((function(t){return"alarm"===t.type})),this.actions.alarm){var a=this.actions.alarm;n.scenario_actions.push({action_type:"3",device_id:"",device_model:"",instruct:"",remark:"",warning_strategy:{id:a.id||"",warning_strategy_name:"",warning_level:a.warningLevel,repeat_count:a.repeatTimes,inform_way:a.notification}})}console.log("handleSubmit.params",Object(o["a"])({},n)),this.formData.id?l["a"].Scene.edit(n).then((function(t){var n=t.data;200===n.code&&(e.dialogVisible=!1,e.$emit("submit"),Object(d["i"])("编辑成功!"))})):l["a"].Scene.add(n).then((function(t){var n=t.data;200===n.code&&(e.dialogVisible=!1,e.$emit("submit"),Object(d["i"])("新增成功!"))})),console.log("====scene.EditForm",this.formData)}},handleCommandChange:function(t,e){var n=this.actions.findIndex((function(e){return e==t}));if(-1!==n){var a=JSON.parse(JSON.stringify(this.actions[n]));a.commands=JSON.parse(JSON.stringify(e)),this.actions.splice(n,1,a),t.commands=e,this.actions.commands=e}},handleSceneChange:function(t,e){this.actions.scenes=e,console.log("handleSceneChange",this.actions)},handleAlarmChange:function(t,e){this.actions.alarm=e},handleDeleteCommand:function(t){var e=this.formData.commands.findIndex((function(e){return e==t}));this.formData.commands.splice(e,1)},getSceneDetail:function(t){var e=this;l["a"].Scene.get({id:t}).then((function(t){var n=t.data;if(200===n.code){var a=(null===n||void 0===n?void 0:n.data)||"{}";if("{}"!==a){console.log("getScene.result",a);var i=JSON.parse(JSON.stringify(a));i.commands=e.getCommands(i),i.scenes=e.getScenes(i),i.alarm=e.getAlarm(i),e.formData=i,e.actions=[],console.log("getSceneDetail.tmp.alarm",i.alarm),i.commands.length&&e.actions.push({type:"device",commands:i.commands}),i.scenes.length&&e.actions.push({type:"scene",scenes:i.scenes}),i.alarm&&e.actions.push({type:"alarm",alarm:i.alarm}),console.log("getSceneDetail",e.actions),e.setActionTypeOptions()}}}))},getCommands:function(t){var e=(null===t||void 0===t?void 0:t.scenario_actions.filter((function(t){return"1"===t.action_type})))||[],n=e.map((function(t){var e=JSON.parse(t.instruct),n=Object.keys(e)[0],a=e[n],i={};return"1"===t.device_model?(i={name:n,mode:"property",operator:{symbol:"",value:a}},JSON.stringify(i)):"2"===t.device_model?(console.log("state11",e),i={name:e.method||"",mode:"command",params:e.params||""},console.log("state11",i),JSON.stringify(i)):"3"===t.device_model&&(i={name:"custom",mode:"custom",params:JSON.parse(t.instruct)},JSON.stringify(i)),{projectId:t.business_id,groupId:t.asset_id,device:t.device_id,deviceId:t.device_id,state:i,stateJSON:JSON.stringify(i)}}));return n},getScenes:function(t){console.log("getScenes.v",t);var e=(null===t||void 0===t?void 0:t.scenario_actions.filter((function(t){return"2"===t.action_type})))||[];return console.log("getScenes.scenes",e),e.map((function(t){var e=JSON.parse(t.instruct);return{id:e.automation_id,switch:e.switch}}))},getAlarm:function(t){var e,n=(null===t||void 0===t||null===(e=t.scenario_actions.find((function(t){return"3"===t.action_type})))||void 0===e?void 0:e.warning_strategy)||"";return n?{id:n.id,warningLevel:n.warning_level,repeatTimes:n.repeat_count,notification:n.inform_way}:null},validate:function(){if(!this.formData.scenario_name||""===this.formData.scenario_name)return this.$refs.nameRef.focus(),Object(d["h"])(this.$t("AUTOMATION.SCENE_NAME")),!1;for(var t=0;t<this.actions.length;t++){var e=this.actions[t];if("device"===e.type&&!this.$refs.commandRef[0].validate())return!1;if("scene"===e.type&&!this.$refs.sceneRef[0].validate())return!1;if("alarm"===e.type&&!this.$refs.alarmRef[0].validate())return!1}return!0}}},h=f,p=(n("b2a5"),n("2877")),v=Object(p["a"])(h,a,i,!1,null,"84d84992",null);e["default"]=v.exports},"37d3":function(t,e,n){"use strict";n.r(e);var a=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"scene-device-box"},t._l(t.sceneList,(function(e,a){return n("div",{key:a,staticStyle:{display:"flex","margin-bottom":"8px"}},[n("el-select",{ref:"sceneIdRef",refInFor:!0,staticStyle:{width:"300px","margin-left":"10px","margin-right":"10px"},attrs:{"no-data-text":t.$t("COMMON.SELECT_NO_DATA")},on:{change:t.handleChange},model:{value:e.id,callback:function(n){t.$set(e,"id",n)},expression:"item.id"}},t._l(t.options,(function(t,e){return n("el-option",{key:e,attrs:{label:t.automation_name,value:t.id}})})),1),n("el-select",{staticStyle:{width:"100px","margin-right":"10px"},on:{change:t.handleChange},model:{value:e.switch,callback:function(n){t.$set(e,"switch",n)},expression:"item.switch"}},[n("el-option",{attrs:{value:"0",label:"停用"}}),n("el-option",{attrs:{value:"1",label:"启用"}})],1),0===a?n("el-button",{attrs:{type:"border",size:"mini"},on:{click:t.handleAddScene}},[t._v("新增一行")]):t._e(),a>0?n("el-button",{staticStyle:{height:"40px"},attrs:{type:"danger",size:"small"},on:{click:function(e){return t.handleDeleteScene(a)}}},[t._v(t._s(t.$t("AUTOMATION.DELETE")))]):t._e()],1)})),0)},i=[],o=n("1da1"),s=(n("96cf"),n("e9c4"),n("d81d"),n("a434"),n("d9e2"),n("6d73")),c=n("2fa3"),r={name:"SceneSelector",props:{data:{type:[Array],default:function(){return[{id:"",switch:"0"}]}}},data:function(){return{sceneId:"",options:[],sceneList:[]}},created:function(){var t=this;return Object(o["a"])(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t.getSceneList(),e.next=3,t.$nextTick();case 3:t.sceneList=JSON.parse(JSON.stringify(t.data)),t.handleChange();case 5:case"end":return e.stop()}}),e)})))()},methods:{getSceneList:function(){var t=this;s["a"].Control.list({current_page:1,per_page:9999}).then((function(e){var n,a=e.data;200===a.code&&(console.log("getSceneList",a.data),t.options=(null===(n=a.data)||void 0===n?void 0:n.data)||[],t.sceneId=t.value)}))},handleChange:function(){var t=this.sceneList.map((function(t){return{id:t.id,switch:t.switch}}));this.$emit("change",t)},handleAddScene:function(){this.sceneList.push({id:"",switch:"0"}),console.log("handleAddScene",this.sceneList)},handleDeleteScene:function(t){this.sceneList.splice(t,1);var e=this.sceneList.map((function(t){return{id:t.id}}));console.log("handleDeleteScene",e),this.$emit("change",e)},validate:function(){console.log("scene.validate");try{for(var t=0;t<this.sceneList.length;t++){var e=this.sceneList[t];if(!e.id)throw new Error("场景不能为空")}return!0}catch(n){return Object(c["h"])(n.message),!1}}}},l=r,d=(n("ff2f"),n("2877")),u=Object(d["a"])(l,a,i,!1,null,"885501aa",null);e["default"]=u.exports},"4127e":function(t,e,n){"use strict";n.r(e);var a=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"command-device-box"},t._l(t.commands,(function(e,a){return n("div",{key:a,staticStyle:{display:"flex","margin-bottom":"10px"}},[n("DeviceTypeSelector",{ref:"deviceTypeRef",refInFor:!0,attrs:{option:{operator:!1,mode:"action"},data:e},on:{change:function(n){return t.handleCommandChange(e,n)}}}),n("span",{staticStyle:{width:"80px","margin-left":"10px","text-align":"right"}},[0==a?n("el-button",{attrs:{type:"indigo",size:"small"},on:{click:t.handleAddCommand}},[t._v(t._s(t.$t("AUTOMATION.ADD_LINE")))]):t._e(),a>0?n("el-button",{attrs:{type:"danger",size:"small"},on:{click:function(n){return t.handleDeleteCommand(e)}}},[t._v(t._s(t.$t("AUTOMATION.DELETE")))]):t._e()],1)],1)})),0)},i=[],o=(n("e9c4"),n("c740"),n("a434"),n("5c97")),s={name:"CommandDevice",components:{DeviceTypeSelector:o["default"]},props:{data:{type:[Array],default:function(){return[]}}},data:function(){return{commands:[]}},watch:{data:{handler:function(t){console.log("CommandDevice.data",t),t&&t.length>0?this.commands=JSON.parse(JSON.stringify(t)):this.commands=[{}]},immediate:!0,deep:!0}},methods:{handleCommandChange:function(t,e){for(var n in e)t[n]=e[n];this.$emit("change",this.commands)},handleAddCommand:function(){this.commands.push({})},handleDeleteCommand:function(t){var e=this.commands.findIndex((function(e){return e==t}));this.commands.splice(e,1),this.$emit("change",this.commands)},validate:function(){for(var t=0;t<this.commands.length;t++)if(this.$refs.deviceTypeRef&&!this.$refs.deviceTypeRef[t].validate())return!1;return!0}}},c=s,r=(n("73b2"),n("2877")),l=Object(r["a"])(c,a,i,!1,null,"3bd68a44",null);e["default"]=l.exports},"6d73":function(t,e,n){"use strict";var a=n("18a6");e["a"]={Scene:{list:function(t){return Object(a["a"])({url:"/scenario/strategy/list",method:"post",data:t})},add:function(t){return Object(a["a"])({url:"/scenario/strategy/add",method:"post",data:t})},edit:function(t){return Object(a["a"])({url:"/scenario/strategy/edit",method:"post",data:t})},delete:function(t){return Object(a["a"])({url:"/scenario/strategy/delete",method:"post",data:t})},get:function(t){return Object(a["a"])({url:"/scenario/strategy/detail",method:"post",data:t})},logList:function(t){return Object(a["a"])({url:"/v1/scenario/log/list",method:"post",data:t})},logDetail:function(t){return Object(a["a"])({url:"/v1/scenario/log/detail/list",method:"post",data:t})},active:function(t){return Object(a["a"])({url:"/scenario/strategy/activate",method:"post",data:t})}},Control:{add:function(t){return Object(a["a"])({url:"/v1/automation/add",method:"post",data:t})},edit:function(t){return Object(a["a"])({url:"/v1/automation/edit",method:"post",data:t})},delete:function(t){return Object(a["a"])({url:"/v1/automation/delete",method:"post",data:t})},enabled:function(t){return Object(a["a"])({url:"/v1/automation/enabled",method:"post",data:t})},list:function(t){return Object(a["a"])({url:"/v1/automation/list",method:"post",data:t})},get:function(t){return Object(a["a"])({url:"/v1/automation/detail",method:"post",data:t})},logList:function(t){return Object(a["a"])({url:"/v1/automation/log/list",method:"post",data:t})},logDetail:function(t){return Object(a["a"])({url:"/v1/automation/log/detail/list",method:"post",data:t})}}}},7197:function(t,e,n){},"73b2":function(t,e,n){"use strict";n("b660")},b2a5:function(t,e,n){"use strict";n("b5c26")},b5c26:function(t,e,n){},b660:function(t,e,n){},ff2f:function(t,e,n){"use strict";n("7197")}}]);